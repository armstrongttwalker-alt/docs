name: Update ModelScope Documentation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'docs/flagrelease_en/model_list.txt'
      - '.github/workflows/update-modelscope-docs.yml'
      - 'docs/scripts/download_readmes.py'

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Git user
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Authenticate Git remote
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Download ModelScope documentation
        id: download
        run: |
          cd "$GITHUB_WORKSPACE"
          python docs/scripts/download_readmes.py
        continue-on-error: true

      # --- æ–°å¢ï¼šç”ŸæˆæŠ¥å‘Šæ­¥éª¤ ---
      - name: Generate download report
        id: generate-report
        run: |
          REPORT_FILE="docs/flagrelease_en/model_readmes/download_report_$(date +'%Y%m%d_%H%M%S').txt"
          echo "# ModelScope Documentation Update Report" > $REPORT_FILE
          echo "## Generated on: $(date)" >> $REPORT_FILE
          echo "## Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          if [ -d "docs/flagrelease_en/model_readmes/" ]; then
            CHANGED_COUNT=$(git diff --name-only docs/flagrelease_en/model_readmes/ 2>/dev/null | wc -l || echo "0")
            echo "## Summary" >> $REPORT_FILE
            echo "- **Total changes detected:** $CHANGED_COUNT files" >> $REPORT_FILE
            echo "" >> $REPORT_FILE

            if [ "$CHANGED_COUNT" -gt 0 ]; then
              echo "## Changed Files" >> $REPORT_FILE
              git diff --name-only docs/flagrelease_en/model_readmes/ | while read file; do
                echo "- $file" >> $REPORT_FILE
              done
              echo "" >> $REPORT_FILE
            fi
          fi

          echo "## Model Download Statistics" >> $REPORT_FILE
          echo "- **Last run status:** ${{ job.status }}" >> $REPORT_FILE
          echo "- **Trigger type:** ${{ github.event_name }}" >> $REPORT_FILE
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "- **Schedule:** Daily at 02:00 UTC (10:00 Beijing Time)" >> $REPORT_FILE
          fi
          echo "" >> $REPORT_FILE

          echo "## Next Steps" >> $REPORT_FILE
          echo "Please review the changes in the model documentation files above." >> $REPORT_FILE
          echo "After merging this PR, the documentation will be updated on the main branch." >> $REPORT_FILE

          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
      # --- æŠ¥å‘Šæ­¥éª¤ç»“æŸ ---

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Auto-update ModelScope documentation [$(date +''%Y-%m-%d %H:%M'')]'
          branch: 'update/modelscope-docs-$(date +''%Y%m%d-%H%M%S'')'
          delete-branch: true
          title: 'ğŸ“š ModelScope Documentation Update - $(date +''%Y-%m-%d'')'
          body-path: ${{ steps.generate-report.outputs.report_file }}  # å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨å…·ä½“æ–‡ä»¶è·¯å¾„å˜é‡
          base: 'main'
          labels: 'documentation, auto-update, modelscope'
          draft: false
